<%# app/views/simple_calendar/_month_calendar.html.erb %>
<%= raw(
  content_tag(:div, class: "simple-calendar w-full") do
    # ðŸ“… æœˆã‚¿ã‚¤ãƒˆãƒ«
    content_tag(:div, start_date.strftime("%Yå¹´ %B"), class: "text-center text-xl font-bold text-gray-800 mb-4") +

    # ðŸ—“ ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æœ¬ä½“
    content_tag(:table, class: "w-full table-fixed border-collapse text-center") do
      # ---- ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆæ—¥æ›œå§‹ã¾ã‚Šï¼‰----
      content_tag(:thead) do
        content_tag(:tr) do
          %w(æ—¥ æœˆ ç« æ°´ æœ¨ é‡‘ åœŸ).each_with_index.map do |day, i|
            klass = case i
              when 0 then "text-red-500"
              when 6 then "text-sky-500"
              else "text-gray-600"
            end
            content_tag(:th, day, class: "#{klass} pb-2 text-[13px] font-semibold")
          end.join.html_safe
        end
      end +

      # ---- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æœ¬ä½“ï¼ˆæ—¥æ›œå§‹ã¾ã‚Šãƒ»6è¡Œå›ºå®šï¼‰----
      content_tag(:tbody) do
        # ðŸ“† ãã®æœˆå…¨ä½“ã®ç¯„å›²
        custom_range = (start_date.beginning_of_month.beginning_of_week(:sunday)..start_date.end_of_month.end_of_week(:sunday)).to_a

        # âœ… è¡Œæ•°ãŒ6æœªæº€ãªã‚‰åŸ‹ã‚ã‚‹
        if (custom_range.size / 7) < 6
          last_date = custom_range.last
          ((6 * 7) - custom_range.size).times { |i| custom_range << (last_date + (i + 1).days) }
        end

        # ðŸ“… å„é€±ã‚’1è¡Œãšã¤å‡ºåŠ›
        custom_range.each_slice(7).map do |week|
          content_tag(:tr) do
            week.map do |date|
              is_today = (date == Date.current)
              is_other_month = (date.month != start_date.month)

              minutes = (@minutes_by_date && @minutes_by_date[date]) ? @minutes_by_date[date].to_i : 0

              bg_class =
                if is_other_month
                  "bg-gray-100 opacity-60"
                else
                  effective_bg_class(minutes)
                end

              today_border_class = is_today ? "border-2 border-black" : ""

              # æ–‡å­—è‰²
              text_class =
                if date.sunday?
                  "text-red-500"
                elsif date.saturday?
                  "text-sky-500"
                else
                  "text-gray-700"
                end

              content_tag(:td, class: "align-top p-0.5") do
                content_tag(:div,
                  class: "flex flex-col items-center justify-center
                          w-[42px] h-[42px] sm:w-[50px] sm:h-[50px]
                          rounded-xl #{bg_class} #{today_border_class}") do

                  # æ—¥ä»˜
                  content_tag(:div,
                    date.day,
                    class: "font-bold text-[13px] #{text_class} #{'opacity-50' if is_other_month}"
                  ) +
                  # æœ‰åŠ¹æ™‚é–“
                  content_tag(:div,
                    passed_block.call(date),
                    class: "text-[10px] mt-0.5 leading-tight
                            #{is_other_month ? 'text-gray-400 opacity-40' : 'text-gray-600'}"
                  )
                end
              end
            end.join.html_safe
          end
        end.join.html_safe
      end
    end
  end
) %>
