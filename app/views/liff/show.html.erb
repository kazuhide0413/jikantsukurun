<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<div class="p-6">
  <h1 class="text-xl font-bold">時間作るん LIFF</h1>
  <p class="mt-2">LIFF 初期化テスト</p>

  <pre id="log"
       class="mt-4 p-3 bg-white rounded border text-xs whitespace-pre-wrap"></pre>
</div>

<script>
  (async () => {
    const log = (msg) => {
      document.getElementById("log").textContent += msg + "\n";
    };

    const liffId = "<%= j @liff_id %>";
    log("LIFF ID: " + liffId);

    try {
      await liff.init({ liffId });
      log("liff.init OK");

      log("isInClient: " + liff.isInClient());
      log("isLoggedIn: " + liff.isLoggedIn());
      log("OS: " + liff.getOS());
      log("Language: " + liff.getLanguage());

      if (!liff.isLoggedIn()) {
        log("Not logged in -> liff.login()");
        liff.login();
        return;
      }

      // id_token を取得して Rails に渡す
      const idToken = liff.getIDToken();
      log("Got id_token: " + (idToken ? "yes" : "no"));

      const res = await fetch("/liff/auth", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id_token: idToken })
      });

      const json = await res.json().catch(() => ({}));

      if (!res.ok) {
        log("AUTH ERROR: " + (json.error || res.status));
        return;
      }

      log("AUTH OK -> redirect");
      window.location.href = json.redirect_to || "/";
    } catch (e) {
      log("ERROR: " + (e.message || e));
      console.error(e);
    }
  })();
</script>
